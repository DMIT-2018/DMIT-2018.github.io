(window.webpackJsonp=window.webpackJsonp||[]).push([[73],{466:function(e,t,a){"use strict";a.r(t);var n=a(2),s=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"erestuarant-sample-demo"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#erestuarant-sample-demo"}},[e._v("#")]),e._v(" eRestuarant Sample/Demo")]),e._v(" "),a("p",[e._v("This sample uses the Entity Framework (EF) in a code-first approach for an existing database. Rather than reverse-engineer the database, these steps walk through creating the entities and the database context classes manually. The purpose of this is to gain a better understanding of how EF works as an ORM to map entities to a database.")]),e._v(" "),a("p",[e._v("Using the Entity Framework, it is possible to model the structure and relationships of database tables in our application. This model is known as a "),a("strong",[e._v("Database Model")]),e._v(" or simple a "),a("strong",[e._v("Model")]),e._v(".")]),e._v(" "),a("p",[e._v("This demo assumes that you already have a VS solution with the Entity Framework included in the class library that the entities will be placed in. As a general rule-of-thumb, you should ensure that all projects in your VS solution that need Entity Framework are using the "),a("em",[e._v("same")]),e._v(" version of the Entity Framework.")]),e._v(" "),a("h2",{attrs:{id:"coding-the-entities"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#coding-the-entities"}},[e._v("#")]),e._v(" Coding the Entities")]),e._v(" "),a("p",[e._v("For the eRestaurant database, the following steps walk through coding the entities that will be mapped against the following three tables: SpecialEvents, Reservations and Tables.")]),e._v(" "),a("p",[a("img",{attrs:{src:"eRestaurant_ERD_entity-demo-tables.png",alt:""}})]),e._v(" "),a("p",[e._v("eRestaurant - Demo Tables")]),e._v(" "),a("h3",{attrs:{id:"the-specialevent-class"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-specialevent-class"}},[e._v("#")]),e._v(" The "),a("code",[e._v("SpecialEvent")]),e._v(" Class")]),e._v(" "),a("p",[e._v("For the SpecialEvents database table, begin by creating a class with properties that will correspond to each column in the database table. Notice that the "),a("code",[e._v("EventCode")]),e._v(" property requires the "),a("code",[e._v("[Key]")]),e._v(" attribute to designate it as mapping to a column that is a primary key.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    public class SpecialEvent\n    {\n        [Key]\n        public string EventCode { get; set; }\n        public string Description { get; set; }\n        public bool Active { get; set; }\n    }\n")])])]),a("p",[e._v("SpecialEvent entity - properties matching columns")]),e._v(" "),a("p",[e._v("Next, add a navigation property that represents the relationship between the SpecialEvents and Reservations tables.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    public class SpecialEvent\n    {\n        [Key]\n        public string EventCode { get; set; }\n        public string Description { get; set; }\n        public bool Active { get; set; }\n\n        public virtual ICollection<Reservation> Reservations { get; set; }\n    }\n")])])]),a("p",[e._v("SpecialEvent entity - with Navigation Property")]),e._v(" "),a("p",[e._v("Lastly, there are some rules around the data in the SpecialEvents table (some of which are represented by constraints such as "),a("code",[e._v("NOT NULL")]),e._v(" or lengths of "),a("code",[e._v("varchar")]),e._v(" types). The following requirements will be supported through validation attributes and default values set through constructors. Note that we are including error messages should the validation rules in the attributes be violated. Attribute-based validation rules are checked as part of the "),a("code",[e._v("SaveChanges()")]),e._v(" method on the database context class, just before the information is sent to the database.")]),e._v(" "),a("ul",[a("li",[e._v("New "),a("code",[e._v("SpecialEvent")]),e._v(" objects are Active by default.")]),e._v(" "),a("li",[e._v("The "),a("code",[e._v("EventCode")]),e._v(" can only be a single character.")]),e._v(" "),a("li",[e._v("The "),a("code",[e._v("Description")]),e._v(" must be between 5 and 30 characters (30 characters is the physical limit based on the "),a("code",[e._v("varchar(30)")]),e._v(" data type on the column, while the minimum value of five characters is based on a general business rule).")])]),e._v(" "),a("p",[e._v("The first requirement will be met through the constructor; whenever a database table has a column with a default constraint, the default value should be set in the constructor of the entity class. The other requirements are met through C# attributes.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    public class SpecialEvent\n    {\n        [Key]\n        [Required(ErrorMessage = "An Event Code is required (one character only)")]\n        [StringLength(1, ErrorMessage="Event Codes can only use a single-character code")]\n        public string EventCode { get; set; }\n        [Required(ErrorMessage = "A Description is required (5-30 characters)")]\n        [StringLength(30, MinimumLength=5, ErrorMessage="Descriptions must be from 5 to 30 characters in length")]\n        public string Description { get; set; }\n        public bool Active { get; set; }\n\n        public virtual ICollection<Reservation> Reservations { get; set; }\n\n        public SpecialEvent()\n        {\n            Active = true;\n        }\n    }\n')])])]),a("p",[e._v("SpecialEvent entity - complete")]),e._v(" "),a("h3",{attrs:{id:"the-reservation-class"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-reservation-class"}},[e._v("#")]),e._v(" The "),a("code",[e._v("Reservation")]),e._v(" Class")]),e._v(" "),a("p",[e._v("For the Reservations database table, the following code shows properties for each column in the table. Note that since the primary key column - "),a("code",[e._v("ReservationID")]),e._v(" - follows a pattern of "),a("code",[e._v("ClassNameID")]),e._v(" (it matches the name of the class, with a suffix of ID), our property will not need the "),a("code",[e._v("[Key]")]),e._v(" attribute to designate it as mapping to a primary key column. This pattern is one of many coding conventions used by the Entity Framework to simplify our C# code for the entity classes.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    public class Reservation\n    {\n        public int ReservationID { get; set; }\n\n        public string CustomerName { get; set; }\n        public DateTime ReservationDate { get; set; }\n        public int NumberInParty { get; set; }\n        public string ContactPhone { get; set; }\n        public string ReservationStatus { get; set; }\n        public string EventCode { get; set; }\n    }\n")])])]),a("p",[e._v("Reservation entity - properties matching columns")]),e._v(" "),a("p",[e._v("The Reservations table has direct relationships with three other tables in the database: SpecialEvents, ReservationsTables and Bills. We will need navigation properties for these. Since the Bills table is not on this partial ERD, we will not include a navigation property to that table.")]),e._v(" "),a("p",[e._v("For the ResevationTables, note that it is only a "),a("a",{attrs:{href:"http://stackoverflow.com/q/1429908/2154662",target:"_blank",rel:"noopener noreferrer"}},[e._v("Gerund"),a("OutboundLink")],1),e._v(" or "),a("a",{attrs:{href:"http://stackoverflow.com/a/1429919/2154662",target:"_blank",rel:"noopener noreferrer"}},[e._v("Join Table"),a("OutboundLink")],1),e._v(" (or, as Martin Fowler prefers to call it, a "),a("a",{attrs:{href:"http://martinfowler.com/eaaCatalog/associationTableMapping.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Link table"),a("OutboundLink")],1),e._v("). As such, ReservationTables is a normalization of a many-to-many relationship between Reservations and Tables:")]),e._v(" "),a("blockquote",[a("p",[e._v("Each "),a("strong",[e._v("Reservation")]),e._v(" may be "),a("em",[e._v("for")]),e._v(" one or more "),a("strong",[e._v("Tables")]),e._v(". Each "),a("strong",[e._v("Table")]),e._v(" may be "),a("em",[e._v("set aside for")]),e._v(" one or more "),a("strong",[e._v("Reservations")]),e._v(".")])]),e._v(" "),a("p",[e._v("Since ReservationTables is being used in this way, we can simplify our model by using navigation properties to directly represent our many-to-many relationship and thereby omit having to create a "),a("code",[e._v("ReservationTable")]),e._v(" entity.")]),e._v(" "),a("p",[e._v("The remaining table - SpecialEvents - will be mapped directly with a navigation property.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    public class Reservation\n    {\n        public int ReservationID { get; set; }\n\n        public string CustomerName { get; set; }\n        public DateTime ReservationDate { get; set; }\n        public int NumberInParty { get; set; }\n        public string ContactPhone { get; set; }\n        public string ReservationStatus { get; set; }\n        public string EventCode { get; set; }\n\n        public virtual SpecialEvent Event { get; set; }\n        public virtual ICollection<Table> Tables { get; set; }\n    }\n")])])]),a("p",[e._v("Resevation entity - with Navigation Properties")]),e._v(" "),a("p",[e._v("Note that since we have not yet coded the "),a("code",[e._v("Table")]),e._v(" class, Visual Studio will alert us to a compiler error for referencing it in our navigation property. For the moment, ignore the error â€“ it will go away once we have coded the "),a("code",[e._v("Table")]),e._v(" entity.")]),e._v(" "),a("p",[e._v("As in the case of "),a("code",[e._v("SpecialEvent")]),e._v(", we will need to add attributes and a constructor for property initializations in order to support the following rules for the data in the Reservations table:")]),e._v(" "),a("ul",[a("li",[e._v("CustomerName, ContactPhone and ReservationStatus are all required.")]),e._v(" "),a("li",[e._v("We can accomodate up to 16 people in a reservation, but the minimum is one.")]),e._v(" "),a("li",[e._v("Maximum string lengths should be applied as noted in the database column's data type.")])]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    public class Reservation\n    {\n        public int ReservationID { get; set; }\n\n        [Required]\n        [StringLength(40)]\n        public string CustomerName { get; set; }\n        public DateTime ReservationDate { get; set; }\n        [Range(1, 16)]\n        public int NumberInParty { get; set; }\n        [StringLength(15)]\n        public string ContactPhone { get; set; }\n        // TODO: (in BLL) Validate acceptable values using constants above\n        [Required, StringLength(1, MinimumLength=1)]\n        public string ReservationStatus { get; set; }\n        [StringLength(1)]\n        public string EventCode { get; set; }\n\n        public virtual SpecialEvent Event { get; set; }\n        public virtual ICollection<Table> Tables { get; set; }\n    }\n")])])]),a("p",[e._v("Reservation entity - validation and business rules")]),e._v(" "),a("p",[e._v("As a final enhancement to the "),a("code",[e._v("Reservation")]),e._v(" entity, it is helpful to note that the ReservationStatus column of the database table has a constraint restricting it to certain acceptable values. This kind of check constraint is too difficult to represent in any of the default validation attributes (at least, difficult without resorting to regular epxressions), and as such is best supported at the BLL. To aid in this, however, we can define a number of constants to represent those values and thereby make our code much easier to read once we reach the BLL.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    public class Reservation\n    {\n        // constants for valid reservation status values\n        // B = Booked; C = Complete; N = No-show; X = Cancelled\n        public const string Booked = "B";\n        public const string Complete = "C";\n        public const string NoShow = "N";\n        public const string Cancelled = "X";\n\n        public int ReservationID { get; set; }\n\n        [Required]\n        [StringLength(40)]\n        public string CustomerName { get; set; }\n        public DateTime ReservationDate { get; set; }\n        [Range(1, 16)]\n        public int NumberInParty { get; set; }\n        [StringLength(15)]\n        public string ContactPhone { get; set; }\n        // TODO: (in BLL) Validate acceptable values using constants above\n        [Required, StringLength(1, MinimumLength=1)]\n        public string ReservationStatus { get; set; }\n        [StringLength(1)]\n        public string EventCode { get; set; }\n\n        public virtual SpecialEvent Event { get; set; }\n        public virtual ICollection<Table> Tables { get; set; }\n    }\n')])])]),a("p",[e._v("Reservation entity - complete")]),e._v(" "),a("h3",{attrs:{id:"the-table-class"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#the-table-class"}},[e._v("#")]),e._v(" The "),a("code",[e._v("Table")]),e._v(" Class")]),e._v(" "),a("p",[e._v("Lastly, we can write the code for the entity representing the Tables database table. This database table will need to support the following constraints/rules:")]),e._v(" "),a("ul",[a("li",[e._v("TableNumber is required and must be a positive number; we only anticipate growing to a maximum of 25 tables.")]),e._v(" "),a("li",[e._v("By default a new table is Available")])]),e._v(" "),a("p",[e._v("Rather than code this step-by-step, the following represents our finished "),a("code",[e._v("Table")]),e._v(" entity.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    public class Table\n    {\n        public int TableID { get; set; }\n        [Required(ErrorMessage="Table Number is required")]\n        [Range(1, 25, ErrorMessage="Table Number must be a positive number")]\n        public byte TableNumber { get; set; }\n        public bool Smoking { get; set; }\n        public int Capacity { get; set; }\n        public bool Available { get; set; }\n\n        public virtual ICollection<Reservation> Reservations { get; set; }\n\n        public Table()\n        {\n            Available = true;\n        }\n    }\n')])])]),a("p",[e._v("Table entity - complete")]),e._v(" "),a("p",[e._v("A few points to note about creating Entity classes:")]),e._v(" "),a("ul",[a("li",[e._v("Always name your entity classes in the singular. An instance of your entity class effectively represents a single row's worth of data in your database table.")]),e._v(" "),a("li",[e._v("By default, Entity Framework can identify a property as mapping to a primary key column by the convention of the property being named either "),a("code",[e._v("ID")]),e._v(" or "),a("code",[e._v("ClassNameID")]),e._v("."),a("br"),e._v("\nEntity Framework has a number of conventions that work well with most database structures. One of those conventions is the naming of Entities in the singular form even though the database is named in the plural form. When a database is named in the plural form, it tends to still name the int-based PK column in its singular (with an ID suffix).")]),e._v(" "),a("li",[e._v("Even though Entity Framework has conventions to recognize a primary key mapped property, you can still use the "),a("code",[e._v("[Key]")]),e._v(" attribute.")]),e._v(" "),a("li",[e._v("Just because a relationship exists between two tables that you are mapping does not mean that you "),a("em",[e._v("have to")]),e._v(" create a Navigation Property in your entities. Navigation properties are helpful for querying while in your BLL and for mirroring the foreign key constraints, but they are not necessary in your entities.")]),e._v(" "),a("li",[e._v('Entity Framework has no built-in mechanism to represent default constraints that might appear in your database table\'s columns. If you want to "mirror" that functionality, then you should set any defaults in the constructor of your entity.')]),e._v(" "),a("li",[e._v("Annotations help to represent simple constraints, but more complex ones - such as that seen in Reservations ReservationStatus column - are better enforced in the BLL.")]),e._v(" "),a("li",[e._v("In all cases, it's helpful to check the database table itself for documentation. Many DBAs will place information about column values or usage right on the database tables and columns through the use of "),a("a",{attrs:{href:"http://sqlblog.com/blogs/michael_coles/archive/2010/01/12/t-sql-tuesday-easy-extended-properties.aspx",target:"_blank",rel:"noopener noreferrer"}},[e._v("extended properties"),a("OutboundLink")],1),e._v(". You can often view this information when looking at the table design in SSMS")])]),e._v(" "),a("h2",{attrs:{id:"coding-the-database-context"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#coding-the-database-context"}},[e._v("#")]),e._v(" Coding the Database Context")]),e._v(" "),a("p",[e._v("The Database Context class is the class that acts as the DAL for our application. Under Entity Framework, a database context class is one that inherits from the "),a("code",[e._v("DbContext")]),e._v(" class (in the "),a("code",[e._v("System.Data.Entity")]),e._v(" namespace). Follow these steps to create a database context class that will support the entities coded above.")]),e._v(" "),a("p",[e._v("First, create the class itself. As a rule of thumb, the DAL is best declared as "),a("code",[e._v("internal")]),e._v(' so as to deter "bypassing" the BLL.')]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("    internal class RestaurantContext : DbContext\n    {\n        \n    }\n")])])]),a("p",[e._v("RestaurantContext - inherting DbContext")]),e._v(" "),a("p",[e._v("Next, it is helpful to specify a named connection string that can be used to obtain the settings to connect to the database. This is most easily specified by using a parameterless constructor that passes a hard-coded name to one of the base-class constructors. By convention, the actual connnection string name should be prefixed by name=. In this example, use the name EatIn.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    internal class RestaurantContext : DbContext\n    {\n        public RestaurantContext() : base("name=EatIn") { }\n    }\n')])])]),a("p",[e._v("RestaurantContext - specify connection string name")]),e._v(" "),a("p",[e._v("Individual tables and their mappings are represented by "),a("code",[e._v("DbSet<T>")]),e._v(" properties on the database context class. The "),a("code",[e._v("DbSet<T>")]),e._v(" class handles the details of the mapping of the table columns to the entity properties. In the database context class, the "),a("code",[e._v("DbSet<T>")]),e._v(" properties should be named the same as the actual database tables, to leverage the default conventions of the Entity Framework in mapping the DbContext's properties to the tables.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    internal class RestaurantContext : DbContext\n    {\n        public RestaurantContext() : base("name=EatIn") { }\n\n        public DbSet<Table> Tables { get; set; }\n        public DbSet<SpecialEvent> SpecialEvents { get; set; }\n        public DbSet<Reservation> Reservations { get; set; }\n    }\n')])])]),a("p",[e._v("RestaurantContext - create properties as maps to tables")]),e._v(" "),a("p",[e._v('Because of the join table ReservationTables operating as the "middleman" between the Reservations and Tables, we need to clarify that mapping in our database context class. Mappings and other aspects of our database model can be controlled through the '),a("code",[e._v("DbContext.OnModelCreating()")]),e._v(" method. By overriding this method, we can add our custom mappings. When overriding "),a("code",[e._v("OnModelCreating()")]),e._v(", it is important to remember to call the base method's implementation before you exit the method.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('    internal class RestaurantContext : DbContext\n    {\n        public RestaurantContext() : base("name=EatIn") { }\n\n        public DbSet<Table> Tables { get; set; }\n        public DbSet<SpecialEvent> SpecialEvents { get; set; }\n        public DbSet<Reservation> Reservations { get; set; }\n\n        protected override void OnModelCreating(DbModelBuilder modelBuilder)\n        {\n            modelBuilder\n                .Entity<Reservation>().HasMany(r => r.Tables)\n                .WithMany(t => t.Reservations)\n                .Map(mapping =>\n                {\n                    mapping.ToTable("ReservationTables");\n                    mapping.MapLeftKey("ReservationID");\n                    mapping.MapRightKey("TableID");\n                });\n            base.OnModelCreating(modelBuilder);\n        }\n    }\n')])])]),a("p",[e._v("RestaurantContext - complete")]),e._v(" "),a("p",[e._v("As the number of entities grows in our system, we can add more properties to our database context class to map those entities to additional database tables.")]),e._v(" "),a("p",[e._v("Here are a few items to note when creating a database context class.")]),e._v(" "),a("ul",[a("li",[e._v("Inherit from "),a("code",[e._v("DbContext")])]),e._v(" "),a("li",[e._v("Call base constructor with "),a("code",[e._v(': base("name=EatIn")')]),e._v(" to connect with specific connection string in web.config or app.config")]),e._v(" "),a("li",[a("code",[e._v("DbSet<T>")]),e._v(" is the appropriate data type to map properties on the database context to tables in the database")]),e._v(" "),a("li",[e._v("Override "),a("code",[e._v("OnModelCreating()")]),e._v(" for any non-default aspects of the relationships between the entities in the model (such as the many-to-many relationship between the Table and Reservation classes)")])])])}),[],!1,null,null,null);t.default=s.exports}}]);