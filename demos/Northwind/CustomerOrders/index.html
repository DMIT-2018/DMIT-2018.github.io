<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Customer Orders | DMIT-2018 Student Notes</title>
    <meta name="description" content="Intermediate Application Development">
    
    
    <link rel="preload" href="/assets/css/0.styles.912ec5d4.css" as="style"><link rel="preload" href="/assets/js/app.0dd3e0ac.js" as="script"><link rel="preload" href="/assets/js/75.d4cc919a.js" as="script"><link rel="prefetch" href="/assets/js/1.7e242e83.js"><link rel="prefetch" href="/assets/js/2.72f922de.js"><link rel="prefetch" href="/assets/js/3.da887197.js"><link rel="prefetch" href="/assets/js/4.0ccfc5cf.js"><link rel="prefetch" href="/assets/js/5.3a64f479.js"><link rel="prefetch" href="/assets/js/6.f2aaf3a8.js"><link rel="prefetch" href="/assets/js/7.a881ad9b.js"><link rel="prefetch" href="/assets/js/8.1598c844.js"><link rel="prefetch" href="/assets/js/9.f1025517.js"><link rel="prefetch" href="/assets/js/10.cff2f355.js"><link rel="prefetch" href="/assets/js/11.ffcc25de.js"><link rel="prefetch" href="/assets/js/12.4ea27a3b.js"><link rel="prefetch" href="/assets/js/13.4f6b2530.js"><link rel="prefetch" href="/assets/js/14.56453d00.js"><link rel="prefetch" href="/assets/js/15.c996a126.js"><link rel="prefetch" href="/assets/js/16.44a2e745.js"><link rel="prefetch" href="/assets/js/17.8970bd0b.js"><link rel="prefetch" href="/assets/js/18.7b817173.js"><link rel="prefetch" href="/assets/js/19.6bb596b2.js"><link rel="prefetch" href="/assets/js/20.e6cd5261.js"><link rel="prefetch" href="/assets/js/21.4c30a4cd.js"><link rel="prefetch" href="/assets/js/22.117269e1.js"><link rel="prefetch" href="/assets/js/23.40640326.js"><link rel="prefetch" href="/assets/js/24.b4128361.js"><link rel="prefetch" href="/assets/js/25.37528cf3.js"><link rel="prefetch" href="/assets/js/26.01f4eb26.js"><link rel="prefetch" href="/assets/js/27.1dcf8670.js"><link rel="prefetch" href="/assets/js/28.ccbc57d4.js"><link rel="prefetch" href="/assets/js/29.a2c81822.js"><link rel="prefetch" href="/assets/js/30.caa344e4.js"><link rel="prefetch" href="/assets/js/31.dc6aa967.js"><link rel="prefetch" href="/assets/js/32.62b10621.js"><link rel="prefetch" href="/assets/js/33.2a6d16da.js"><link rel="prefetch" href="/assets/js/34.951372f3.js"><link rel="prefetch" href="/assets/js/35.ba701f0e.js"><link rel="prefetch" href="/assets/js/36.b772b969.js"><link rel="prefetch" href="/assets/js/37.fa7f0a2b.js"><link rel="prefetch" href="/assets/js/38.c262a7f5.js"><link rel="prefetch" href="/assets/js/39.8c891891.js"><link rel="prefetch" href="/assets/js/40.4ecd3ecb.js"><link rel="prefetch" href="/assets/js/41.c0e406c5.js"><link rel="prefetch" href="/assets/js/42.33d3e6fb.js"><link rel="prefetch" href="/assets/js/43.e4c9875e.js"><link rel="prefetch" href="/assets/js/44.a1e3330d.js"><link rel="prefetch" href="/assets/js/45.09fddc43.js"><link rel="prefetch" href="/assets/js/46.13c59adf.js"><link rel="prefetch" href="/assets/js/47.4d40149f.js"><link rel="prefetch" href="/assets/js/48.12a09333.js"><link rel="prefetch" href="/assets/js/49.c4a44c18.js"><link rel="prefetch" href="/assets/js/50.2f100ce8.js"><link rel="prefetch" href="/assets/js/51.0038b69d.js"><link rel="prefetch" href="/assets/js/52.29087a10.js"><link rel="prefetch" href="/assets/js/53.e1c9540f.js"><link rel="prefetch" href="/assets/js/54.63ccb7e1.js"><link rel="prefetch" href="/assets/js/55.1cde8ff2.js"><link rel="prefetch" href="/assets/js/56.a51bc721.js"><link rel="prefetch" href="/assets/js/57.60467a82.js"><link rel="prefetch" href="/assets/js/58.d4d80a43.js"><link rel="prefetch" href="/assets/js/59.6b65ca8a.js"><link rel="prefetch" href="/assets/js/60.eb1b5998.js"><link rel="prefetch" href="/assets/js/61.3f5eebf7.js"><link rel="prefetch" href="/assets/js/62.38bbf3ce.js"><link rel="prefetch" href="/assets/js/63.843677fa.js"><link rel="prefetch" href="/assets/js/64.0c4c1391.js"><link rel="prefetch" href="/assets/js/65.9d0da62b.js"><link rel="prefetch" href="/assets/js/66.f5326e93.js"><link rel="prefetch" href="/assets/js/67.6f048a01.js"><link rel="prefetch" href="/assets/js/68.b0bd49cc.js"><link rel="prefetch" href="/assets/js/69.1f11741f.js"><link rel="prefetch" href="/assets/js/70.3cd7ba03.js"><link rel="prefetch" href="/assets/js/71.f06d6116.js"><link rel="prefetch" href="/assets/js/72.c709c8ce.js"><link rel="prefetch" href="/assets/js/73.da11654d.js"><link rel="prefetch" href="/assets/js/74.fafbe8db.js"><link rel="prefetch" href="/assets/js/76.69c04ae4.js"><link rel="prefetch" href="/assets/js/77.50337cf1.js"><link rel="prefetch" href="/assets/js/78.e224cf98.js"><link rel="prefetch" href="/assets/js/79.e9d56b4d.js"><link rel="prefetch" href="/assets/js/80.f91b8d65.js"><link rel="prefetch" href="/assets/js/81.c136d9ec.js"><link rel="prefetch" href="/assets/js/82.997e43c9.js"><link rel="prefetch" href="/assets/js/83.0fcf8013.js"><link rel="prefetch" href="/assets/js/84.11721266.js"><link rel="prefetch" href="/assets/js/85.10d55821.js"><link rel="prefetch" href="/assets/js/86.f446fc7f.js"><link rel="prefetch" href="/assets/js/87.c008627c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.912ec5d4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DMIT-2018 Student Notes</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/topics/" class="nav-link">Notes</a></div><div class="nav-item"><a href="/demos/" class="nav-link router-link-active">Demos</a></div><div class="nav-item"><a href="https://DMIT-2018.github.io/LabSpecs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Lab Specs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/slides-installing-sql-server.html#" class="nav-link">MS SQL 2017</a></div><div class="nav-item"><a href="/exercises/" class="nav-link">Take Home</a></div><div class="nav-item"><a href="https://github.com/DMIT-2018/StudentNotes/issues/new" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Issues/Bugs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://moodle.nait.ca" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Moodle
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/about/" class="nav-link">About</a></div><div class="nav-item"><a href="/topics/" class="nav-link">Notes</a></div><div class="nav-item"><a href="/demos/" class="nav-link router-link-active">Demos</a></div><div class="nav-item"><a href="https://DMIT-2018.github.io/LabSpecs" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Lab Specs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="/about/slides-installing-sql-server.html#" class="nav-link">MS SQL 2017</a></div><div class="nav-item"><a href="/exercises/" class="nav-link">Take Home</a></div><div class="nav-item"><a href="https://github.com/DMIT-2018/StudentNotes/issues/new" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Issues/Bugs
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://moodle.nait.ca" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Moodle
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/demos/Northwind/" class="sidebar-link">Northwind Traders Demo</a></li><li><a href="/demos/Northwind/linq/LinqPad/expressions.html" class="sidebar-link">C# Expressions in LinqPad</a></li><li><a href="/demos/Northwind/linq/LinqPad/statements.html" class="sidebar-link">C# Statements in LinqPad</a></li><li><a href="/demos/Northwind/linq/LinqPad/program.html" class="sidebar-link">C# Program in LinqPad</a></li><li><a href="/demos/Northwind/CustomerOrders/" class="active sidebar-link">Customer Orders</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/demos/Northwind/CustomerOrders/#open-the-sales-page" class="sidebar-link">Open the Sales Page</a></li><li class="sidebar-sub-header"><a href="/demos/Northwind/CustomerOrders/#selected-customer" class="sidebar-link">Selected Customer</a></li><li class="sidebar-sub-header"><a href="/demos/Northwind/CustomerOrders/#edit-new-existing-order" class="sidebar-link">Edit New/Existing Order</a></li><li class="sidebar-sub-header"><a href="/demos/Northwind/CustomerOrders/#query-responsibility" class="sidebar-link">Query Responsibility</a></li><li class="sidebar-sub-header"><a href="/demos/Northwind/CustomerOrders/#adding-removing-items" class="sidebar-link">Adding/Removing Items</a></li><li class="sidebar-sub-header"><a href="/demos/Northwind/CustomerOrders/#command-responsibility" class="sidebar-link">Command Responsibility</a></li><li class="sidebar-sub-header"><a href="/demos/Northwind/CustomerOrders/#saving-customer-orders" class="sidebar-link">Saving Customer Orders</a></li><li class="sidebar-sub-header"><a href="/demos/Northwind/CustomerOrders/#placing-customer-orders" class="sidebar-link">Placing Customer Orders</a></li></ul></li><li><a href="/demos/Northwind/CustomerOrders/Design.html" class="sidebar-link">Customer Orders Design Plan</a></li><li><a href="/demos/Northwind/Security/" class="sidebar-link">ASP.Net Identity</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="customer-orders"><a href="#customer-orders" aria-hidden="true" class="header-anchor">#</a> Customer Orders</h1> <p>The customers of Northwind Traders place their orders by phone or fax. Employees then enter the details of the order into the system via the <strong>Customer Order Form</strong> (from the <em>Sales</em> menu item on the website).</p> <p>The form allows employees to create new orders and view previous orders. Any order whose <em>Order Date</em> has been set cannot be modified, because that order has been <em>&quot;Placed&quot;</em>.</p> <p>An order without an Order Date can be modified. It may be an order that is <em>&quot;In Progress&quot;</em> (saved, but not placed), or an entirely new order.</p> <p>The screen mockups in the following sections describe the planned user experience (UX) in working with the form.</p> <hr> <h2 id="open-the-sales-page"><a href="#open-the-sales-page" aria-hidden="true" class="header-anchor">#</a> Open the Sales Page</h2> <p>The first visit to the Sales page simply displays a list of existing customers that the employee can select from to view the customer's order history or to create a new order for the customer.</p> <blockquote><p><img src="/assets/img/First-Visit.b96b47f0.png" alt="Sales Page - First Visit"></p></blockquote> <p>For the drop-down, only the Company Name and Customer Id are required on the form, so a simple POCO class geared to the needs of a drop-down is needed.</p> <blockquote><p><img src="/assets/img/Query-First-Visit.d613e3fb.png" alt="Sales Page - Data Query for First Visit"></p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeyValueOption</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Key <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Text <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Clicking on the [Select] button will trigger the next major view of this page: the Selected Customer.</p> <hr> <h2 id="selected-customer"><a href="#selected-customer" aria-hidden="true" class="header-anchor">#</a> Selected Customer</h2> <p>When a customer is selected, the general company information is displayed, along with the order history of the customer. Order history is divided into two sets - Orders that have been shipped, and orders that have not been shipped (i.e.: &quot;Open&quot; orders).</p> <blockquote><p><img src="/assets/img/Selected-Company.62e53b9f.png" alt="Customer Order History"></p></blockquote> <p>When querying the database for this information, it quickly becomes clear that POCOs/DTOs are the most appropriate way to send information to the form.</p> <blockquote><p><img src="/assets/img/Query-Selected-Company.b5eea4a1.png" alt="Customer Order History - Data Query"></p></blockquote> <p>General customer information can be represented by a simple POCO, and the data is retrieved via code-behind. Part of the reason for this is that the data must be un-packed manually in the code-behind, since it is a <em>single</em> customer whose information is retrieved.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerSummary</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> CompanyName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ContactName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Phone <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Fax <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Likewise, each line of the order history details can also be represented by a simple POCO. In this case, however, the data can be retrieved either manually in code-behind or through an <code>&lt;asp:ObjectDataSource&gt;</code> control.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerOrder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Employee <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> DateTime<span class="token operator">?</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> DateTime<span class="token operator">?</span> RequiredDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> DateTime<span class="token operator">?</span> ShippedDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Shipper <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">decimal</span><span class="token operator">?</span> Freight <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">decimal</span> OrderTotal <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h2 id="edit-new-existing-order"><a href="#edit-new-existing-order" aria-hidden="true" class="header-anchor">#</a> Edit New/Existing Order</h2> <p>When editing a new or existing order, <strong>summary information</strong> on the order needs to be available (relevant dates, shipping info, order total) as well as <strong>detail information</strong> on the order items.</p> <blockquote><p><img src="/assets/img/Edit-Order.e5c76994.png" alt="Edit Order View"></p></blockquote> <p>If the order is new or <strong>not placed</strong> (which means that there is no <code>OrderDate</code>), then the order can be edited and saved. Once an order is placed (i.e., the <em>Order Date</em> is set), then the order cannot be edited. This makes the form helpful for viewing details of placed orders (shipped or not shipped) while protecting the data from being inadvertantly changed.</p> <hr> <h2 id="query-responsibility"><a href="#query-responsibility" aria-hidden="true" class="header-anchor">#</a> Query Responsibility</h2> <p>Loading the form with an order populates the summary and detail information. This information is obtained from a single call to the BLL, which retrieves a DTO constructed from parts of the entities. Drop-downs use the same general-purpose POCO as was used earlier when displaying customers.</p> <blockquote><p><img src="/assets/img/Query-Open-Order.8d7011e0.png" alt="Query Open Order" title="Query Open Order"></p></blockquote> <p>The DTO/POCO used for populating the order summary/details uses the following classes.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerOrderWithDetails</span> <span class="token punctuation">:</span> <span class="token class-name">CustomerOrder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>CustomerOrderItem<span class="token operator">&gt;</span> Details <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">List</span><span class="token punctuation">&lt;</span><span class="token class-name">CustomerOrderItem</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerOrderItem</span> <span class="token punctuation">:</span> <span class="token class-name">ProductItem</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">short</span> Quantity <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> DiscountPercent <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductItem</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> ProductId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ProductName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> QuantityPerUnit <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">decimal</span> UnitPrice <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">short</span><span class="token operator">?</span> InStockQuantity <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You may notice that the <code>ProductItem</code> is the base class for the <code>CustomerOrderItem</code>. This class inheritance was introduced because the <code>ProductItem</code> information is needed in another code-behind query - the one used to add items to the order.</p> <hr> <h2 id="adding-removing-items"><a href="#adding-removing-items" aria-hidden="true" class="header-anchor">#</a> Adding/Removing Items</h2> <p>When editing the order, all changes are persisted on the form only, rather than making hits to the BLL/DAL on each minor change. The reason for this is that the edit form is functioning as a <strong>working document</strong> - changes are not persisted unless the user clicks the [Save] or [Place Order] buttons.</p> <blockquote><p><img src="/assets/img/Form-State-Edit-Order.47f6c12d.png" alt="Add/Remove Items"></p></blockquote> <p>As such, this requires a good deal of code-behind processing on the form. For example, when the user selects a product to add to the order, the pricing information is queried from the database to fill in the suggested order price. But when the user clicks the [Add] button, all of this information is manually placed into the list view's data.</p> <p>Processes like this can make use of additional queries to the database (as in the query for <code>ProductItem</code> details), but no commands are issued to the BLL.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductItem</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> ProductId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ProductName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> QuantityPerUnit <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">decimal</span> UnitPrice <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">short</span><span class="token operator">?</span> InStockQuantity <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h2 id="command-responsibility"><a href="#command-responsibility" aria-hidden="true" class="header-anchor">#</a> Command Responsibility</h2> <p>Editing the order is done by adding and removing order items as well as selecting the shipper, setting the freight, and entering the date that the order is required. None of these editing actions perform an update on the database directly. Rather, the changes are simply preserved on the form itself through the form's code-behind.</p> <blockquote><p><img src="/assets/img/Form-State-Edit-Order.47f6c12d.png" alt="Form State"></p></blockquote> <p>Once all the editing is done, the user can either <strong>Save</strong> or <strong>Place</strong> the order. Both of these actions are performed as distinct transactions, meaning that all the relevant data from the form is sent to the BLL through a DTO.</p> <blockquote><p><img src="/assets/img/Command-Save-Order.f95844dd.png" alt="Save Order"></p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EditOrderItem</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> ProductId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">decimal</span> UnitPrice <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">short</span> OrderQuantity <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> DiscountPercent <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EditCustomerOrder</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> CustomerId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> EmployeeId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> DateTime<span class="token operator">?</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> DateTime<span class="token operator">?</span> RequiredDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token operator">?</span> ShipperId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">decimal</span><span class="token operator">?</span> FreightCharge <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>EditOrderItem<span class="token operator">&gt;</span> OrderItems <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h2 id="saving-customer-orders"><a href="#saving-customer-orders" aria-hidden="true" class="header-anchor">#</a> Saving Customer Orders</h2> <p>Saving a customer order is done to preserve changes to an order while keeping it open (i.e., not setting the <code>OrderDate</code>). The customer order to be saved may be a new order or an existing open order. Both of these are handled by a single public BLL method, which internally shunts the main work of saving to two alternate private methods. Each private method ensures that their specific tasks are performed as <strong>transactions</strong> that succeed or fail as a group. The following sequence diagram roughly illustrates the process.</p> <p><img src="/assets/img/Northwind-CustomerSales-Save.c8a6d630.png" alt="Save Customer Order - Sequence Diagram"></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Save</span><span class="token punctuation">(</span><span class="token class-name">EditCustomerOrder</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Always ensure you have been given data to work with</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Cannot save order; order information was not supplied.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Business validation rules</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>OrderDate<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span>$<span class="token string">&quot;An order date of {order.OrderDate.Value.ToLongDateString()} has been supplied. The order date should only be supplied when placing orders, not saving them.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Decide whether to add new or update</span>
    <span class="token comment">//  NOTE: Notice that no db activity is occuring yet.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>OrderId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">AddPendingOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">UpdatePendingOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <code>Save()</code> method performs initial validation, ensuring that the order exists and that the order date is not set. In either case, the order is open (or &quot;pending&quot;), and the work of saving changes ir routed to two separate methods, each of which ensure that the order is <strong>processed as a <em>single</em> transaction</strong>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">AddPendingOrder</span><span class="token punctuation">(</span><span class="token class-name">EditCustomerOrder</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NorthwindContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> orderInProcess <span class="token operator">=</span> context<span class="token punctuation">.</span>Orders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Make the orderInProcess match the customer order as given...</span>
        <span class="token comment">// A) The general order information</span>
        orderInProcess<span class="token punctuation">.</span>CustomerID <span class="token operator">=</span> order<span class="token punctuation">.</span>CustomerId<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>EmployeeID <span class="token operator">=</span> order<span class="token punctuation">.</span>EmployeeId<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>OrderDate <span class="token operator">=</span> order<span class="token punctuation">.</span>OrderDate<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>ShipVia <span class="token operator">=</span> order<span class="token punctuation">.</span>ShipperId<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>Freight <span class="token operator">=</span> order<span class="token punctuation">.</span>FreightCharge<span class="token punctuation">;</span>
        <span class="token comment">// B) Add order details</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> item <span class="token keyword">in</span> order<span class="token punctuation">.</span>OrderItems<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// Add as a new item</span>
            <span class="token keyword">var</span> newItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderDetail</span>
            <span class="token punctuation">{</span>
                ProductID <span class="token operator">=</span> item<span class="token punctuation">.</span>ProductId<span class="token punctuation">,</span>
                Quantity <span class="token operator">=</span> item<span class="token punctuation">.</span>OrderQuantity<span class="token punctuation">,</span>
                UnitPrice <span class="token operator">=</span> item<span class="token punctuation">.</span>UnitPrice<span class="token punctuation">,</span>
                Discount <span class="token operator">=</span> item<span class="token punctuation">.</span>DiscountPercent
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            orderInProcess<span class="token punctuation">.</span>OrderDetails<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// C) Save the changes (one save, one transaction)</span>
        context<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">UpdatePendingOrder</span><span class="token punctuation">(</span><span class="token class-name">EditCustomerOrder</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NorthwindContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> orderInProcess <span class="token operator">=</span> context<span class="token punctuation">.</span>Orders<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Make the orderInProcess match the customer order as given...</span>
        <span class="token comment">// A) The general order information</span>
        orderInProcess<span class="token punctuation">.</span>CustomerID <span class="token operator">=</span> order<span class="token punctuation">.</span>CustomerId<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>EmployeeID <span class="token operator">=</span> order<span class="token punctuation">.</span>EmployeeId<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>OrderDate <span class="token operator">=</span> order<span class="token punctuation">.</span>OrderDate<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>ShipVia <span class="token operator">=</span> order<span class="token punctuation">.</span>ShipperId<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>Freight <span class="token operator">=</span> order<span class="token punctuation">.</span>FreightCharge<span class="token punctuation">;</span>

        <span class="token comment">// B) Add/Update/Delete order details</span>
        <span class="token comment">//    Loop through the items as known in the database (to update/remove)</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> detail <span class="token keyword">in</span> orderInProcess<span class="token punctuation">.</span>OrderDetails<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> changes <span class="token operator">=</span> order<span class="token punctuation">.</span>OrderItems<span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">&gt;</span> x<span class="token punctuation">.</span>ProductId <span class="token operator">==</span> detail<span class="token punctuation">.</span>ProductID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>changes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Deleted<span class="token punctuation">;</span> <span class="token comment">// flag for deletion</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                detail<span class="token punctuation">.</span>Discount <span class="token operator">=</span> changes<span class="token punctuation">.</span>DiscountPercent<span class="token punctuation">;</span>
                detail<span class="token punctuation">.</span>Quantity <span class="token operator">=</span> changes<span class="token punctuation">.</span>OrderQuantity<span class="token punctuation">;</span>
                detail<span class="token punctuation">.</span>UnitPrice <span class="token operator">=</span> changes<span class="token punctuation">.</span>UnitPrice<span class="token punctuation">;</span>
                context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Modified<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//    Loop through the new items to add to the database</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> item <span class="token keyword">in</span> order<span class="token punctuation">.</span>OrderItems<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">bool</span> notPresent <span class="token operator">=</span> <span class="token operator">!</span>orderInProcess<span class="token punctuation">.</span>Order_Details<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">&gt;</span> x<span class="token punctuation">.</span>ProductID <span class="token operator">==</span> item<span class="token punctuation">.</span>ProductId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>notPresent<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// Add as a new item</span>
                <span class="token keyword">var</span> newItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order_Detail</span>
                <span class="token punctuation">{</span>
                    ProductID <span class="token operator">=</span> item<span class="token punctuation">.</span>ProductId<span class="token punctuation">,</span>
                    Quantity <span class="token operator">=</span> item<span class="token punctuation">.</span>OrderQuantity<span class="token punctuation">,</span>
                    UnitPrice <span class="token operator">=</span> item<span class="token punctuation">.</span>UnitPrice<span class="token punctuation">,</span>
                    Discount <span class="token operator">=</span> item<span class="token punctuation">.</span>DiscountPercent
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                orderInProcess<span class="token punctuation">.</span>Order_Details<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// C) Save the changes (one save, one transaction)</span>
        context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>orderInProcess<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Modified<span class="token punctuation">;</span>
        context<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h2 id="placing-customer-orders"><a href="#placing-customer-orders" aria-hidden="true" class="header-anchor">#</a> Placing Customer Orders</h2> <p>Placing customer orders is much like saving, except that the order date must be set.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">PlaceOrder</span><span class="token punctuation">(</span><span class="token class-name">EditCustomerOrder</span> order<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// Always ensure you have been given data to work with</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Cannot place order; order information was not supplied.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Business validation rules</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>order<span class="token punctuation">.</span>RequiredDate<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span>$<span class="token string">&quot;A  required date for the order is required when placing orders.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>order<span class="token punctuation">.</span>OrderDate<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span>$<span class="token string">&quot;An order date is required when placing orders.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>order<span class="token punctuation">.</span>ShipperId<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;A shipper must be identified before placing an order.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order<span class="token punctuation">.</span>OrderItems<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;An order must have at least one item before it can be placed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Begin processing the order</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NorthwindContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Prep for processing...</span>
        <span class="token keyword">var</span> customer <span class="token operator">=</span> context<span class="token punctuation">.</span>Customers<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>CustomerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>customer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Customer does not exist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> orderInProcess <span class="token operator">=</span> context<span class="token punctuation">.</span>Orders<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInProcess <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            orderInProcess <span class="token operator">=</span> context<span class="token punctuation">.</span>Orders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>orderInProcess<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Modified<span class="token punctuation">;</span>
        <span class="token comment">// Make the orderInProcess match the customer order as given...</span>
        <span class="token comment">// A) The general order information</span>
        orderInProcess<span class="token punctuation">.</span>CustomerID <span class="token operator">=</span> order<span class="token punctuation">.</span>CustomerId<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>EmployeeID <span class="token operator">=</span> order<span class="token punctuation">.</span>EmployeeId<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>OrderDate <span class="token operator">=</span> order<span class="token punctuation">.</span>OrderDate<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>RequiredDate <span class="token operator">=</span> order<span class="token punctuation">.</span>RequiredDate<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>ShipVia <span class="token operator">=</span> order<span class="token punctuation">.</span>ShipperId<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>Freight <span class="token operator">=</span> order<span class="token punctuation">.</span>FreightCharge<span class="token punctuation">;</span>
        <span class="token comment">// B) Default the ship-to info to the customer's info</span>
        orderInProcess<span class="token punctuation">.</span>ShipName <span class="token operator">=</span> customer<span class="token punctuation">.</span>CompanyName<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>ShipAddress <span class="token operator">=</span> customer<span class="token punctuation">.</span>Address<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>ShipCity <span class="token operator">=</span> customer<span class="token punctuation">.</span>City<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>ShipRegion <span class="token operator">=</span> customer<span class="token punctuation">.</span>Region<span class="token punctuation">;</span>
        orderInProcess<span class="token punctuation">.</span>ShipPostalCode <span class="token operator">=</span> customer<span class="token punctuation">.</span>PostalCode<span class="token punctuation">;</span>

        <span class="token comment">// C) Add/Remove/Update order details</span>
        <span class="token comment">//var toRemove = new List&lt;OrderDetail&gt;();</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> detail <span class="token keyword">in</span> orderInProcess<span class="token punctuation">.</span>OrderDetails<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> changes <span class="token operator">=</span> order<span class="token punctuation">.</span>OrderItems<span class="token punctuation">.</span><span class="token function">SingleOrDefault</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">&gt;</span> x<span class="token punctuation">.</span>ProductId <span class="token operator">==</span> detail<span class="token punctuation">.</span>ProductID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>changes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token comment">//toRemove.Add(detail);</span>
                context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Deleted<span class="token punctuation">;</span> <span class="token comment">// flag for deletion</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                detail<span class="token punctuation">.</span>Discount <span class="token operator">=</span> changes<span class="token punctuation">.</span>DiscountPercent<span class="token punctuation">;</span>
                detail<span class="token punctuation">.</span>Quantity <span class="token operator">=</span> changes<span class="token punctuation">.</span>OrderQuantity<span class="token punctuation">;</span>
                detail<span class="token punctuation">.</span>UnitPrice <span class="token operator">=</span> changes<span class="token punctuation">.</span>UnitPrice<span class="token punctuation">;</span>
                context<span class="token punctuation">.</span><span class="token function">Entry</span><span class="token punctuation">(</span>detail<span class="token punctuation">)</span><span class="token punctuation">.</span>State <span class="token operator">=</span> EntityState<span class="token punctuation">.</span>Modified<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> item <span class="token keyword">in</span> order<span class="token punctuation">.</span>OrderItems<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>orderInProcess<span class="token punctuation">.</span>OrderDetails<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">&gt;</span> x<span class="token punctuation">.</span>ProductID <span class="token operator">==</span> item<span class="token punctuation">.</span>ProductId<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// Add as a new item</span>
                <span class="token keyword">var</span> newItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderDetail</span>
                <span class="token punctuation">{</span>
                    ProductID <span class="token operator">=</span> item<span class="token punctuation">.</span>ProductId<span class="token punctuation">,</span>
                    Quantity <span class="token operator">=</span> item<span class="token punctuation">.</span>OrderQuantity<span class="token punctuation">,</span>
                    UnitPrice <span class="token operator">=</span> item<span class="token punctuation">.</span>UnitPrice<span class="token punctuation">,</span>
                    Discount <span class="token operator">=</span> item<span class="token punctuation">.</span>DiscountPercent
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                orderInProcess<span class="token punctuation">.</span>OrderDetails<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>newItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// D) Save the changes (one save, one transaction)</span>
        context<span class="token punctuation">.</span><span class="token function">SaveChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">11/6/2018, 1:55:54 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        
        <a href="/demos/Northwind/linq/LinqPad/program.html" class="prev">
          C# Program in LinqPad
        </a></span> <span class="next"><a href="/demos/Northwind/CustomerOrders/Design.html">
          Customer Orders Design Plan
        </a>
        
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/75.d4cc919a.js" defer></script><script src="/assets/js/app.0dd3e0ac.js" defer></script>
  </body>
</html>
